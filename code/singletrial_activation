#!/usr/bin/env python

# Script for plotting per-subject single-trial voxel data with MNI coordinates

# Adapted from: https://github.com/GttNeuro/Guo-Lab_datapaper

import os
import nibabel as nib
import pandas as pd
import numpy as np
import re

# Set paths
root = '../data/derivatives/singletrial'
output_dir = '../data_for_analysis'
os.makedirs(output_dir, exist_ok=True)

# Gather relevant image paths
data = []
for sub in os.listdir(root):
    if '001' <= sub.split('-')[1] <= '077':
        sub_dir = os.path.join(root, sub)
        if os.path.isdir(sub_dir):
            for file in os.listdir(sub_dir):
                if file.endswith('singletrial-Act.nii.gz') and 'task-CognitiveControl' in file:
                    task = re.search(r'task-(.*)_run', file).group(1)
                    file_path = os.path.join(sub_dir, file)
                    data.append([sub, task, file_path])

df = pd.DataFrame(data, columns=['sub', 'task', 'image'])

# Filter for the task of interest
task = 'CognitiveControl'
task_df = df[df['task'] == task]

# Process each subject's image
all_voxel_data = []

for idx, row in task_df.iterrows():
    sub = row['sub']
    image_path = row['image']
    
    img = nib.load(image_path)
    img_data = img.get_fdata()
    affine = img.affine

    # Get non-zero voxel indices and values
    nonzero_indices = np.argwhere(img_data != 0)
    voxel_values = img_data[img_data != 0]

    # Convert voxel indices to homogeneous coordinates
    ones = np.ones((nonzero_indices.shape[0], 1))
    homogeneous_vox = np.hstack([nonzero_indices, ones])  # Shape (N, 4)

    # Apply affine transformation to get MNI coordinates
    mni_coords = (affine @ homogeneous_vox.T).T[:, :3]  # Shape (N, 3)

    # Store data with subject ID
    subject_data = pd.DataFrame({
        'subject': sub,
        'x': mni_coords[:, 0],
        'y': mni_coords[:, 1],
        'z': mni_coords[:, 2],
        'value': voxel_values
    })

    all_voxel_data.append(subject_data)

# Combine all into a single DataFrame
all_voxel_df = pd.concat(all_voxel_data, ignore_index=True)

# Save to CSV
csv_path = os.path.join(output_dir, f'VoxelData_task-{task}.csv')
all_voxel_df.to_csv(csv_path, index=False)

print(f"Detailed voxel-level data saved to: {csv_path}")
